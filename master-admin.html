<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterAdmin | Enterprise Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, collection, doc, onSnapshot, updateDoc, 
            addDoc, query, orderBy, getDocs, deleteDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcp0fkuwhOOyO7fgAlbCoftWwkuog-vwQ",
            authDomain: "quickcv-47c99.firebaseapp.com",
            projectId: "quickcv-47c99",
            storageBucket: "quickcv-47c99.firebasestorage.app",
            messagingSenderId: "541347686112",
            appId: "1:541347686112:web:b821dd7213ab8674959285"
        };

        // Initialize Global Enterprise State
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.MasterState = {
            admins: [],
            credits: { used: 0, total: 10000 },
            tank: [],
            activeTab: 'dashboard'
        };

        // --- REAL-TIME DATA STREAMING (WEBSOCKETS) ---

        // 1. Live Admin Stream
        onSnapshot(query(collection(db, "admins"), orderBy("name")), (snap) => {
            window.MasterState.admins = snap.docs.map(d => ({id: d.id, ...d.data()}));
            refreshUI();
        });

        // 2. Live Credit Stream
        onSnapshot(doc(db, "system", "credits"), (snap) => {
            if(snap.exists()) {
                window.MasterState.credits = snap.data();
                updateCreditUI();
            }
        });

        // 3. Live Holding Tank Stream
        onSnapshot(collection(db, "tank"), (snap) => {
            window.MasterState.tank = snap.docs.map(d => ({id: d.id, ...d.data()}));
            if(window.MasterState.activeTab === 'tank') renderTankView();
        });

        // --- COMMAND LOGIC ---

        window.toggleAdmin = async (id, current) => {
            await updateDoc(doc(db, "admins", id), { 
                toggle: !current, 
                status: !current ? "Active" : "Offline" 
            });
        };

        window.provisionNewAdmin = async () => {
            const email = document.getElementById('newAdminEmail').value;
            if(!email) return;
            await addDoc(collection(db, "admins"), {
                name: email.split('@')[0],
                email,
                processed: 0,
                score: "100%",
                toggle: true,
                status: "Active"
            });
            closeModal('adminModal');
        };

        window.systemLogout = () => signOut(auth).then(() => location.reload());

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #2563eb; --success: #10b981; --danger: #ef4444; --bg: #f8fafc; }
        body { background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #0f172a; overflow: hidden; }
        .sidebar-item { transition: 0.2s; border-radius: 12px; cursor: pointer; }
        .sidebar-item.active { background: #1e3a8a; color: white; box-shadow: 0 10px 15px -3px rgba(30,58,138,0.4); }
        .glass { background: white; border: 1px solid #e2e8f0; border-radius: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .progress-bar { height: 12px; background: #e2e8f0; border-radius: 50px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #3b82f6, #10b981); transition: 1s ease; }
        .live-pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="flex h-screen">

    <aside class="w-80 bg-white border-r p-6 flex flex-col">
        <div class="mb-10">
            <h1 class="text-2xl font-black tracking-tighter">MASTER<span class="text-blue-600">ADMIN</span></h1>
            <div class="flex items-center gap-2 mt-2">
                <div class="w-2 h-2 rounded-full bg-emerald-500 live-pulse"></div>
                <span class="text-[10px] font-bold text-slate-400 uppercase">Neural Link Active</span>
            </div>
        </div>

        <nav class="space-y-2 flex-1">
            <div onclick="switchView('dashboard')" id="nav-dashboard" class="sidebar-item active p-4 flex items-center gap-4 font-bold text-sm">
                <i class="fas fa-th-large w-5"></i> Dashboard
            </div>
            <div onclick="switchView('admins')" id="nav-admins" class="sidebar-item p-4 flex items-center gap-4 font-bold text-sm text-slate-500">
                <i class="fas fa-user-shield w-5"></i> Admin Seats
            </div>
            <div onclick="switchView('tank')" id="nav-tank" class="sidebar-item p-4 flex items-center gap-4 font-bold text-sm text-slate-500">
                <i class="fas fa-box-archive w-5"></i> Holding Tank
            </div>
            <div onclick="switchView('credits')" id="nav-credits" class="sidebar-item p-4 flex items-center gap-4 font-bold text-sm text-slate-500">
                <i class="fas fa-wallet w-5"></i> CV Credits
            </div>
        </nav>

        <button onclick="systemLogout()" class="mt-auto border border-red-100 text-red-500 p-4 rounded-xl font-bold text-xs hover:bg-red-50 transition">
            <i class="fas fa-power-off mr-2"></i> TERMINATE SYSTEM
        </button>
    </aside>

    <main class="flex-1 overflow-y-auto p-10">
        
        <section id="view-dashboard" class="tab-content active space-y-8">
            <header>
                <h2 class="text-4xl font-black text-slate-800 tracking-tight">Executive Control</h2>
                <p class="text-slate-400 font-medium">Global operational telemetry and seat management.</p>
            </header>

             <div class="p-6 rounded-2xl bg-black text-white shadow-xl shadow-slate-300">
             <p class="text-xs font-bold uppercase opacity-70">Total Revenue (R2.50/CV)</p>
             <h3 class="text-4xl font-black mt-1" id="stat-revenue">R0.00</h3>
             </div>
                <div class="p-6 rounded-2xl bg-emerald-500 text-white shadow-xl shadow-emerald-200">
                    <p class="text-xs font-bold uppercase opacity-70">Tank Volume</p>
                    <h3 class="text-4xl font-black mt-1" id="stat-tank">0</h3>
                </div>
                <div class="p-6 rounded-2xl bg-white border border-slate-200 shadow-sm">
                    <p class="text-xs font-bold uppercase text-slate-400">System Uptime</p>
                    <h3 class="text-4xl font-black mt-1 text-slate-800">99.9%</h3>
                </div>
                <div class="p-6 rounded-2xl bg-red-500 text-white shadow-xl shadow-red-200">
                    <p class="text-xs font-bold uppercase opacity-70">Data Latency</p>
                    <h3 class="text-4xl font-black mt-1">12ms</h3>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-8">
                <div class="glass p-8">
                    <h3 class="text-lg font-black mb-6 uppercase tracking-widest text-slate-400">Credit Burn Rate</h3>
                    <div class="progress-bar"><div id="credit-fill" class="progress-fill" style="width: 0%"></div></div>
                    <div class="flex justify-between mt-4 font-black text-xs text-slate-500 uppercase">
                        <span id="credit-val">0 / 0 used</span>
                        <span class="text-blue-600">Unlimited Tier</span>
                    </div>
                </div>
                <div class="glass p-8">
                    <h3 class="text-lg font-black mb-6 uppercase tracking-widest text-slate-400">Quick Provision</h3>
                    <div class="flex gap-4">
                        <input type="text" id="quickEmail" placeholder="New Admin Email" class="flex-1 bg-slate-50 border p-3 rounded-xl font-bold outline-none">
                        <button onclick="document.getElementById('newAdminEmail').value=document.getElementById('quickEmail').value; provisionNewAdmin();" class="bg-blue-600 text-white px-6 rounded-xl font-black">+</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="view-admins" class="tab-content space-y-6">
            <h2 class="text-3xl font-black">Authorized Personnel</h2>
            <div class="glass overflow-hidden">
                <table class="w-full text-left">
                    <thead class="bg-slate-50 border-b">
                        <tr class="text-[10px] font-black text-slate-400 uppercase">
                            <th class="p-6">Operator</th>
                            <th>Status</th>
                            <th>Processed</th>
                            <th>Accuracy</th>
                            <th class="p-6">Access Control</th>
                        </tr>
                    </thead>
                    <tbody id="admin-table-body"></tbody>
                </table>
            </div>
        </section>

        <section id="view-tank" class="tab-content space-y-6">
            <h2 class="text-3xl font-black">Holding Tank (Raw Data)</h2>
            <div class="grid grid-cols-3 gap-6" id="tank-grid"></div>
        </section>

    </main>

    <div id="adminModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden flex items-center justify-center z-[100]">
        <div class="bg-white p-10 rounded-[30px] w-96 shadow-2xl">
            <h3 class="text-2xl font-black mb-6">Authorize Seat</h3>
            <input type="email" id="newAdminEmail" placeholder="Email Address" class="w-full border p-4 rounded-xl mb-4 font-bold">
            <div class="flex gap-4">
                <button onclick="closeModal('adminModal')" class="flex-1 font-bold text-slate-400">Cancel</button>
                <button onclick="provisionNewAdmin()" class="flex-1 bg-blue-600 text-white p-4 rounded-xl font-black">GRANT ACCESS</button>
            </div>
        </div>
    </div>

    <script>
        // --- VIEW CONTROLLER ---
        function switchView(viewId) {
            window.MasterState.activeTab = viewId;
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.sidebar-item').forEach(s => s.classList.remove('active', 'text-white'));
            
            document.getElementById('view-' + viewId).classList.add('active');
            document.getElementById('nav-' + viewId).classList.add('active');
            
            if(viewId === 'tank') renderTankView();
        }

        // --- CORE UI SYNC ---
        function refreshUI() {
            const admins = window.MasterState.admins;
            
            // Update Stats
            document.getElementById('stat-active').innerText = admins.filter(a => a.toggle).length;
            document.getElementById('stat-tank').innerText = window.MasterState.tank.length;

            // Render Table
            const tbody = document.getElementById('admin-table-body');
            tbody.innerHTML = admins.map(a => `
                <tr class="border-b hover:bg-slate-50 transition">
                    <td class="p-6">
                        <div class="font-black text-slate-700">${a.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold">${a.email}</div>
                    </td>
                    <td>
                        <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase ${a.toggle ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-400'}">
                            ${a.status}
                        </span>
                    </td>
                    <td class="font-bold text-sm">${a.processed || 0}</td>
                    <td class="font-black text-blue-600">${a.score || '100%'}</td>
                    <td class="p-6">
                        <div onclick="toggleAdmin('${a.id}', ${a.toggle})" class="w-12 h-6 rounded-full relative cursor-pointer transition-all ${a.toggle ? 'bg-emerald-500' : 'bg-slate-200'}">
                            <div class="absolute top-1 w-4 h-4 bg-white rounded-full transition-all ${a.toggle ? 'left-7' : 'left-1'}"></div>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function updateCreditUI() {
            const { used, total } = window.MasterState.credits;
            const pct = (used / total) * 100;
            document.getElementById('credit-fill').style.width = pct + '%';
            document.getElementById('credit-val').innerText = `${used.toLocaleString()} / ${total.toLocaleString()} CREDITS`;
        }

        function renderTankView() {
            const grid = document.getElementById('tank-grid');
            grid.innerHTML = window.MasterState.tank.map(item => `
                <div class="glass p-6">
                    <div class="text-[10px] font-black text-blue-600 uppercase mb-2">${item.source || 'Direct Upload'}</div>
                    <div class="font-black text-slate-800">${item.candidateName}</div>
                    <div class="text-xs text-slate-400 mb-4">${new Date(item.timestamp?.seconds * 1000).toLocaleDateString()}</div>
                    <button class="w-full py-2 bg-slate-800 text-white rounded-lg font-bold text-[10px] uppercase">Route to Admin</button>
                </div>
            `).join('');
        }

        // --- UTILS ---
        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    </script>
</body>
</html>

