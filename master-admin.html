<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MasterAdmin | Enterprise Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, onSnapshot, updateDoc, addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBcp0fkuwhOOyO7fgAlbCoftWwkuog-vwQ",
            authDomain: "quickcv-47c99.firebaseapp.com",
            projectId: "quickcv-47c99",
            storageBucket: "quickcv-47c99.firebasestorage.app",
            messagingSenderId: "541347686112",
            appId: "1:541347686112:web:b821dd7213ab8674959285"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // Global State attached to Firebase
        window.AppState = {
            admins: [],
            credits: { total: 10000, used: 0 }
        };

        // --- LIVE DATA SYNC ---

        // 1. Sync Credits (Money & Usage Control)
        onSnapshot(doc(db, "system", "credits"), (snapshot) => {
            if (snapshot.exists()) {
                window.AppState.credits = snapshot.data();
                updateCreditUI();
            }
        });

        // 2. Sync Admins (User & Access Control)
        const adminsQuery = query(collection(db, "admins"), orderBy("name", "asc"));
        onSnapshot(adminsQuery, (snapshot) => {
            window.AppState.admins = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderAdmins();
            renderPerformance();
            updateStats();
        });

        // --- FIREBASE ACTIONS ---

        // Provision New Admin
        window.provisionSeat = async () => {
            const email = document.getElementById('newAdminEmail').value;
            const level = document.getElementById('newAdminLevel').value;
            if(!email) return alert("Enter admin email");

            try {
                await addDoc(collection(db, "admins"), {
                    name: email.split('@')[0],
                    email: email,
                    level: level,
                    status: "Active",
                    toggle: true,
                    processed: 0,
                    score: "100%",
                    createdAt: new Date()
                });
                closeModal('adminModal');
                document.getElementById('newAdminEmail').value = "";
            } catch (e) { alert("Error provisioning seat: " + e.message); }
        };

        // Kill Switch / Toggle Admin
        window.toggleAdminSeat = async (docId, currentStatus) => {
            const adminRef = doc(db, "admins", docId);
            await updateDoc(adminRef, {
                toggle: !currentStatus,
                status: !currentStatus ? "Active" : "Offline"
            });
        };

        // Global Logout
        window.systemLogout = () => {
            if(confirm("DANGER: Terminate session?")) {
                signOut(auth).then(() => window.location.reload());
            }
        };

    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        :root { --primary: #2563eb; --success: #5d9e72; --danger: #e35d5d; --main-bg: #f4f7fa; }
        body { background-color: var(--main-bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #1e293b; overflow: hidden; }
        .glass-panel { background: #ffffff; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); border-radius: 1.25rem; }
        .sidebar-link { transition: all 0.2s ease; border-radius: 0.75rem; margin-bottom: 0.25rem; }
        .sidebar-link.active { background: #1e3a8a; color: white; box-shadow: 0 10px 15px -3px rgba(30, 58, 138, 0.3); }
        .stat-card-green { background: var(--success); color: white; }
        .stat-card-blue { background: #3b5998; color: white; }
        .stat-card-white { background: white; border-top: 4px solid var(--primary); }
        .stat-card-red { background: var(--danger); color: white; }
        .progress-container { height: 10px; background: #e2e8f0; border-radius: 999px; overflow: hidden; }
        .progress-fill { height: 100%; background: var(--success); transition: width 1s ease; }
        .live-pulse { animation: pulse-ring 2s infinite; }
        @keyframes pulse-ring { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .custom-toggle { width: 38px; height: 20px; background: #cbd5e1; border-radius: 20px; position: relative; cursor: pointer; }
        .custom-toggle.active { background: var(--success); }
        .toggle-circle { width: 14px; height: 14px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: 0.3s; }
        .custom-toggle.active .toggle-circle { transform: translateX(18px); }
        main { height: 100vh; overflow-y: auto; }
    </style>
</head>
<body class="flex">

    <aside class="w-72 bg-white h-screen flex flex-col p-6 border-r border-slate-200 z-50">
        <div class="mb-10 px-2">
            <h1 class="text-2xl font-extrabold tracking-tighter text-slate-800">MASTER<span class="text-blue-600">ADMIN</span></h1>
            <p class="text-[10px] font-bold text-slate-400 tracking-widest uppercase">Enterprise Command</p>
        </div>
        <nav class="flex-1 space-y-1">
            <a href="#" onclick="switchTab('dashboard')" id="nav-dashboard" class="sidebar-link active flex items-center gap-4 p-4 font-bold text-sm">
                <i class="fas fa-chart-pie w-5"></i> Dashboard
            </a>
            <a href="#" onclick="switchTab('admins')" id="nav-admins" class="sidebar-link flex items-center gap-4 p-4 font-bold text-sm text-slate-500">
                <i class="fas fa-user-shield w-5"></i> Admin Seats
            </a>
            <a href="#" onclick="switchTab('tank')" id="nav-tank" class="sidebar-link flex items-center gap-4 p-4 font-bold text-sm text-slate-500">
                <i class="fas fa-database w-5"></i> Holding Tank
            </a>
            <a href="#" onclick="switchTab('credits')" id="nav-credits" class="sidebar-link flex items-center gap-4 p-4 font-bold text-sm text-slate-500">
                <i class="fas fa-credit-card w-5"></i> CV Credits
            </a>
        </nav>
        <div class="mt-auto bg-slate-50 rounded-2xl p-4">
            <div class="flex items-center gap-3 mb-3">
                <div class="w-2 h-2 rounded-full bg-emerald-500 live-pulse"></div>
                <span class="text-[10px] font-black uppercase text-slate-400">System Online</span>
            </div>
            <button onclick="systemLogout()" class="w-full bg-white border border-red-100 text-red-500 py-3 rounded-xl text-xs font-bold">
                Terminate Session
            </button>
        </div>
    </aside>

    <main class="flex-1 p-8">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h2 id="view-title" class="text-3xl font-black text-slate-800 tracking-tight">Executive Dashboard</h2>
                <p id="view-subtitle" class="text-slate-400 font-medium">Real-time system integrity.</p>
            </div>
        </header>

        <div id="view-dashboard" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div class="stat-card-green p-6 rounded-2xl flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold uppercase opacity-80">Active Admins</p>
                        <h3 class="text-4xl font-black mt-1" id="stat-active-admins">0</h3>
                    </div>
                    <i class="fas fa-users-cog text-3xl opacity-30"></i>
                </div>
                <div class="stat-card-blue p-6 rounded-2xl flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold uppercase opacity-80">CVs Processed</p>
                        <h3 class="text-4xl font-black mt-1" id="stat-total-processed">0</h3>
                    </div>
                    <i class="fas fa-microchip text-3xl opacity-30"></i>
                </div>
                <div class="stat-card-white p-6 rounded-2xl flex justify-between items-start glass-panel">
                    <div>
                        <p class="text-xs font-bold uppercase text-slate-400">System Alerts</p>
                        <h3 class="text-4xl font-black mt-1 text-slate-800">Healthy</h3>
                    </div>
                    <i class="fas fa-bolt text-3xl text-slate-100"></i>
                </div>
                <div class="stat-card-red p-6 rounded-2xl flex justify-between items-start">
                    <div>
                        <p class="text-xs font-bold uppercase opacity-80">Critical Issues</p>
                        <h3 class="text-4xl font-black mt-1">0</h3>
                    </div>
                    <i class="fas fa-triangle-exclamation text-3xl opacity-30"></i>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <div class="lg:col-span-5 space-y-6">
                    <div class="glass-panel p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-bold text-slate-700 uppercase text-sm tracking-widest">Seat Management</h3>
                            <button onclick="openModal('adminModal')" class="bg-blue-50 text-blue-600 text-[10px] px-3 py-2 rounded-lg font-black">+ Provision</button>
                        </div>
                        <div class="space-y-1" id="admin-render-area"></div>
                    </div>
                </div>

                <div class="lg:col-span-7 space-y-6">
                    <div class="glass-panel p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="font-black text-slate-800 text-lg uppercase">Credit Utilization</h3>
                            <span id="low-credit-tag" class="hidden bg-amber-100 text-amber-700 text-[10px] px-3 py-1 rounded-full font-black">LOW BALANCE</span>
                        </div>
                        <div class="relative pt-4 pb-2">
                            <div class="progress-container"><div class="progress-fill" id="credit-bar" style="width: 0%;"></div></div>
                            <div class="flex justify-between mt-3 text-[10px] font-black text-slate-500 uppercase">
                                <span id="credits-left-text">0 Remaining</span>
                                <span id="credits-cap-text">0 Cap</span>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel p-6">
                        <h3 class="font-bold text-slate-700 mb-6 text-sm uppercase tracking-widest">Performance Matrix</h3>
                        <table class="w-full text-left">
                            <thead><tr class="text-[10px] font-black text-slate-400 uppercase border-b"><th>Operator</th><th class="text-center">Volume</th><th class="text-right">Accuracy</th></tr></thead>
                            <tbody id="performance-render-area"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="adminModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[100] hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-[2rem] w-full max-w-md p-10">
            <h3 class="text-2xl font-black text-slate-800 mb-2">New Seat Authorization</h3>
            <div class="space-y-4">
                <input type="email" id="newAdminEmail" placeholder="admin@enterprise.com" class="w-full bg-slate-50 border p-4 rounded-xl outline-none">
                <select id="newAdminLevel" class="w-full bg-slate-50 border p-4 rounded-xl outline-none">
                    <option>Standard Reviewer</option><option>Quality Assurance</option>
                </select>
                <div class="flex gap-4 pt-6">
                    <button onclick="closeModal('adminModal')" class="flex-1 font-bold text-slate-400">Cancel</button>
                    <button onclick="provisionSeat()" class="flex-1 bg-blue-600 text-white py-4 rounded-xl font-black text-xs uppercase">Generate Seat</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UI RENDERING (Linked to Firebase State) ---
        function renderAdmins() {
            const area = document.getElementById('admin-render-area');
            area.innerHTML = window.AppState.admins.map(admin => `
                <div class="flex justify-between items-center p-4 border-b hover:bg-slate-50 transition-all rounded-xl">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center font-black text-[10px] text-slate-400">${admin.name[0]}</div>
                        <div>
                            <p class="text-sm font-bold text-slate-700">${admin.name}</p>
                            <p class="text-[10px] text-slate-400 font-medium">${admin.email}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="text-[9px] font-black uppercase ${admin.toggle ? 'text-emerald-500' : 'text-slate-300'}">${admin.status}</span>
                        <div class="custom-toggle ${admin.toggle ? 'active' : ''}" onclick="toggleAdminSeat('${admin.id}', ${admin.toggle})">
                            <div class="toggle-circle"></div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPerformance() {
            const area = document.getElementById('performance-render-area');
            area.innerHTML = window.AppState.admins.map(admin => `
                <tr class="border-b hover:bg-slate-50 transition">
                    <td class="py-4 text-xs font-bold text-slate-700">${admin.name}</td>
                    <td class="py-4 text-center text-xs font-black">${admin.processed || 0}</td>
                    <td class="py-4 text-right text-xs font-black text-blue-500">${admin.score || '0%'}</td>
                </tr>
            `).join('');
        }

        function updateCreditUI() {
            const { used, total } = window.AppState.credits;
            const pct = (used / total) * 100;
            document.getElementById('credit-bar').style.width = pct + '%';
            document.getElementById('credits-left-text').innerText = `${(total - used).toLocaleString()} Remaining`;
            document.getElementById('credits-cap-text').innerText = `${total.toLocaleString()} Cap`;
            document.getElementById('low-credit-tag').classList.toggle('hidden', (total - used) > 500);
        }

        function updateStats() {
            const activeCount = window.AppState.admins.filter(a => a.toggle).length;
            const totalProcessed = window.AppState.admins.reduce((acc, a) => acc + (a.processed || 0), 0);
            document.getElementById('stat-active-admins').innerText = activeCount;
            document.getElementById('stat-total-processed').innerText = totalProcessed.toLocaleString();
        }

        window.switchTab = (tabId) => {
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.getElementById('nav-' + tabId).classList.add('active');
        };

        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    </script>
</body>
</html>

