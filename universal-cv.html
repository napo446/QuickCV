<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickCV | Universal Decision Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        /* Dashboard UI Styles */
        body { background-color: #070b14; font-family: 'Inter', sans-serif; color: #f8fafc; overflow-x: hidden; }
        .glass-panel { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .premium-gradient { background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%); }

        /* CV RENDER AREA - STRICT PHOTO ALIGNMENT */
        #cvRenderArea { 
            width: 210mm; 
            min-height: 297mm;
            background: white; 
            color: #1e293b; 
            position: absolute; 
            left: -9999px; 
            padding: 20mm 15mm;
            box-sizing: border-box;
        }

        /* Executive Header */
        .cv-header { text-align: center; margin-bottom: 10px; }
        .cv-name { 
            font-size: 28pt; 
            font-weight: 700; 
            color: #1e3a8a; /* Deep Executive Blue */
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        .cv-title { 
            font-size: 14pt; 
            font-weight: 500; 
            color: #1e3a8a; 
            margin-bottom: 15px;
        }
        .cv-contact-bar { 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            font-size: 9pt; 
            color: #475569;
            margin-bottom: 20px;
        }

        /* Section Header - Fixed to match photo lines */
        .pdf-section-header {
            width: 100%;
            display: block;
            font-size: 10pt;
            font-weight: 700;
            color: #1e3a8a;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid #cbd5e1; /* Thin line as seen in photo */
            padding-bottom: 3px;
            margin-top: 20px;
            margin-bottom: 12px;
        }

        /* Content Styling */
        .pdf-summary-text { font-size: 9.5pt; line-height: 1.5; color: #334155; margin-bottom: 15px; }
        
        .pdf-experience-item { margin-bottom: 18px; page-break-inside: avoid; }
        .pdf-exp-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 2px; }
        .pdf-exp-role { font-size: 10pt; font-weight: 700; color: #1e3a8a; }
        .pdf-exp-meta { font-size: 9pt; font-weight: 400; color: #64748b; }
        
        .pdf-achievement-row {
            display: flex;
            margin-bottom: 4px;
            padding-left: 5px;
            font-size: 9pt;
            line-height: 1.4;
            color: #334155;
        }
        .pdf-bullet { color: #1e3a8a; margin-right: 8px; font-weight: 900; }

        /* Live Preview Logic */
        [contenteditable="true"]:focus { outline: none; background: rgba(37, 99, 235, 0.05); }
        #previewModal { background: rgba(0, 0, 0, 0.95); }
        
        #cvRenderArea, #livePreviewCV {
            -webkit-font-smoothing: antialiased;
            text-rendering: optimizeLegibility;
        }
    </style>
</head>
    <body>
    <div id="saveStatus" class="fixed bottom-32 right-10 opacity-0 transition-opacity duration-500 bg-emerald-500 text-white text-[10px] font-bold px-4 py-2 rounded-full shadow-lg z-[100]">
        <i class="fas fa-cloud-upload-alt mr-2"></i> SYNCED TO CLOUD
    </div>

    <nav class="max-w-7xl mx-auto p-6 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <a href="template.html" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center hover:bg-white/10 transition">
                <i class="fas fa-arrow-left text-xs text-slate-400"></i>
            </a>
            <h1 class="text-xl font-black tracking-tighter">QuickCV <span class="text-blue-500">UNIVERSAL</span></h1>
            <div id="accessStatus"></div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto p-6 pb-32">
        
        <section id="universal-logic" class="mb-12">
            <div class="glass-panel p-8 rounded-[2.5rem] border-blue-500/30 bg-gradient-to-br from-blue-600/5 to-transparent">
                <h3 class="text-sm font-black uppercase tracking-widest text-blue-400 mb-6">Step 1: Universal Career Context</h3>
                <div class="grid md:grid-cols-3 gap-6">
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Career Level</label>
                        <select id="careerLevel" onchange="autoGenerateEverything()" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 text-white font-bold">
                            <option value="Entry Level">Entry Level / Graduate</option>
                            <option value="Mid-Level">Mid-Level Professional</option>
                            <option value="Senior">Senior Professional</option>
                            <option value="Manager">Manager / Lead</option>
                            <option value="Executive">Executive / C-Suite</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Impact Scale</label>
                        <select id="impactScale" onchange="autoGenerateEverything()" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 text-white font-bold">
                            <option value="individual">Individual Contributor</option>
                            <option value="team">Team Impact</option>
                            <option value="department">Department Impact</option>
                            <option value="organization">Organization Impact</option>
                            <option value="global">Global Impact</option>
                        </select>
                    </div>
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-slate-400 uppercase ml-2">Role Cluster</label>
                        <select id="roleCluster" onchange="autoGenerateEverything()" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 text-white font-bold">
                            <option value="Operations">Operations & Process</option>
                            <option value="Finance">Finance & Strategy</option>
                            <option value="Technology">Technology & IT</option>
                            <option value="Sales">Sales & Marketing</option>
                            <option value="HR">Human Resources</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <section class="space-y-6 mb-12">
            <h3 class="text-lg font-black uppercase tracking-widest text-slate-500">Identity & Contact</h3>
            <div class="glass-panel p-8 rounded-[2.5rem] grid md:grid-cols-2 gap-6">
                <input type="text" id="fullName" placeholder="FULL NAME" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 text-white font-bold uppercase">
                <input type="text" id="jobTitle" placeholder="PROFESSIONAL TITLE" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500 text-white font-bold uppercase">
                <input type="text" id="phone" placeholder="PHONE" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                <input type="email" id="email" placeholder="EMAIL" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                <input type="text" id="linkedin" placeholder="LINKEDIN URL" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
                <input type="text" id="location" placeholder="LOCATION (CITY, COUNTRY)" class="w-full bg-white/5 border border-white/10 p-4 rounded-2xl outline-none focus:border-blue-500">
            </div>
        </section>

        <section class="space-y-6 mb-12">
            <div class="flex justify-between items-end">
                <h3 class="text-lg font-black uppercase tracking-widest text-slate-500">Professional Summary</h3>
                <button onclick="autoGenerateEverything()" class="text-[10px] bg-blue-500 text-white px-4 py-2 rounded-full font-bold hover:bg-blue-400 transition shadow-lg shadow-blue-500/20">
                    <i class="fas fa-magic mr-1"></i> RE-GENERATE
                </button>
            </div>
            <div class="glass-panel p-8 rounded-[2.5rem]">
                <textarea id="summary" rows="4" class="w-full bg-white/5 border border-white/10 p-6 rounded-2xl outline-none focus:border-blue-500 text-slate-300 leading-relaxed"></textarea>
            </div>
        </section>

        <section class="space-y-6 mb-12">
            <div class="flex justify-between items-center">
                <h3 class="text-lg font-black uppercase tracking-widest text-slate-500">Experience</h3>
                <button onclick="addExperience()" class="bg-blue-600/10 text-blue-400 text-xs font-black px-4 py-2 rounded-xl border border-blue-600/20">+ ADD ROLE</button>
            </div>
            <div id="experienceList" class="space-y-6"></div>
        </section>

        <section class="grid md:grid-cols-2 gap-8 mb-12">
            <div class="space-y-6">
                <h3 class="text-lg font-black uppercase tracking-widest text-slate-500">Core Competencies</h3>
                <div class="glass-panel p-6 rounded-[2.5rem]">
                    <div id="skillsContainer" class="flex flex-wrap gap-2 mb-4"></div>
                    <div class="flex gap-2">
                        <input type="text" id="skillInput" placeholder="Skill..." class="flex-1 bg-white/5 border border-white/10 p-3 rounded-xl text-sm">
                        <button onclick="addSkill()" class="bg-blue-600 text-white px-4 rounded-xl font-bold">ADD</button>
                    </div>
                </div>
            </div>
            <div class="space-y-6">
                <div class="flex justify-between items-center">
                    <h3 class="text-lg font-black uppercase tracking-widest text-slate-500">Education</h3>
                    <button onclick="addEducation()" class="text-blue-400 text-[10px] font-bold">+ ADD</button>
                </div>
                <div id="educationList" class="space-y-4"></div>
            </div>
        </section>

        <div class="fixed bottom-0 left-0 w-full glass-panel p-6 z-[50] flex justify-center">
            <button onclick="window.showExecutivePreview()" class="premium-gradient px-12 py-5 rounded-2xl font-black uppercase text-sm tracking-[2px] shadow-2xl hover:scale-105 active:scale-95 transition-all">
                <i class="fas fa-eye mr-2"></i> Review & Generate
            </button>
        </div>
    </main>

    <div id="cvRenderArea">
        <div class="cv-header">
            <div id="pdf-name" class="cv-name">RYAN ANDERSON</div>
            <div id="pdf-title" class="cv-title">Operations & Process Improvement Specialist</div>
            <div id="pdf-contact" class="cv-contact-bar"></div>
        </div>

        <div class="pdf-section-header">Professional Summary</div>
        <p id="pdf-summary" class="pdf-summary-text"></p>

        <div class="pdf-section-header">Core Competencies</div>
        <div id="pdf-skills" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; font-size: 9pt; color: #334155; margin-bottom: 20px;"></div>

        <div class="pdf-section-header">Professional Experience</div>
        <div id="pdf-experience"></div>

        <div class="pdf-section-header">Education</div>
        <div id="pdf-education" style="font-size: 9.5pt; color: #334155;"></div>

        <div class="pdf-section-header">Certifications</div>
        <div id="pdf-certs" style="font-size: 9pt; color: #334155;"></div>
    </div>

    <div id="previewModal" class="fixed inset-0 z-[100] hidden overflow-y-auto p-4 md:p-10">
        <div class="max-w-5xl mx-auto">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black text-white uppercase">Final Review</h2>
                <div class="flex gap-4">
                    <button onclick="closePreview()" class="px-6 py-2 bg-white/10 text-white rounded-xl">Edit Fields</button>
                    <button onclick="executeFinalDownload()" class="px-8 py-2 premium-gradient text-white rounded-xl font-bold">Download PDF</button>
                </div>
            </div>
            <div id="previewContainer" class="flex justify-center bg-white shadow-2xl rounded-lg"></div>
        </div>
    </div>
</body>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // --- CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyBcp0fkuwhOOyO7fgAlbCoftWwkuog-vwQ",
        authDomain: "quickcv-47c99.firebaseapp.com",
        projectId: "quickcv-47c99",
        storageBucket: "quickcv-47c99.firebasestorage.app",
        messagingSenderId: "541347686112",
        appId: "1:541347686112:web:b821dd7213ab8674959285"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- STATE MANAGEMENT ---
    window.skills = [];
    window.customCerts = [];
    let userHasAccess = false;

    // --- AUTH OBSERVER ---
    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            window.location.href = 'user.html';
            return;
        }
        await checkAccess(user);
        await loadFromFirebase(user);
    });

    // --- ACCESS CONTROL ---
    async function checkAccess(user) {
        const userRef = doc(db, "users", user.uid);
        const userSnap = await getDoc(userRef);
        const badge = document.getElementById('accessStatus');

        if (userSnap.exists() && (userSnap.data().credits > 0)) {
            userHasAccess = true;
            if (badge) {
                badge.innerHTML = `<i class="fas fa-coins text-amber-500 mr-1"></i> ${userSnap.data().credits} Credits Remaining`;
                badge.className = "text-[10px] font-bold text-blue-400 uppercase tracking-widest";
            }
        } else {
            denyAccess();
        }
    }

    // --- THE QUICKCV UNIVERSAL GENERATOR ---
    window.autoGenerateEverything = function() {
        const level = document.getElementById('careerLevel').value;
        const impact = document.getElementById('impactScale').value;
        const cluster = document.getElementById('roleCluster').value;
        
        // 1. Generate Executive Title if blank
        const titleField = document.getElementById('jobTitle');
        if (!titleField.value) {
            titleField.value = `${level} ${cluster} Specialist`.toUpperCase();
        }

        // 2. Generate Professional Summary Logic
        const summaries = {
            "Executive": `Visionary ${cluster} Executive with a record of driving ${impact}-wide excellence. Expert in strategic alignment and high-stakes transformation.`,
            "Senior": `Results-driven ${cluster} Professional with extensive experience leading ${impact} initiatives and optimizing complex operational workflows.`,
            "Manager": `Dedicated ${cluster} Lead focused on team performance, process efficiency, and delivering measurable ${impact} results.`,
            "Mid-Level": `Detail-oriented ${cluster} Professional with a proven track record of supporting ${impact} objectives through technical expertise.`,
            "Entry Level": `Ambitious ${cluster} Graduate equipped with foundational knowledge and a commitment to contributing to ${impact} goals.`
        };

        document.getElementById('summary').value = summaries[level] || summaries["Mid-Level"];
        saveToFirebase();
    };

    // --- FIREBASE PERSISTENCE ---
    window.saveToFirebase = async function() {
        const user = auth.currentUser;
        if (!user) return;

        const draftData = {
            fullName: document.getElementById('fullName').value,
            jobTitle: document.getElementById('jobTitle').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            linkedin: document.getElementById('linkedin').value,
            location: document.getElementById('location').value,
            summary: document.getElementById('summary').value,
            careerLevel: document.getElementById('careerLevel').value,
            impactScale: document.getElementById('impactScale').value,
            roleCluster: document.getElementById('roleCluster').value,
            skills: window.skills,
            customCerts: window.customCerts,
            experience: Array.from(document.querySelectorAll('#experienceList > div')).map(card => ({
                company: card.querySelector('.exp-company')?.value || '',
                role: card.querySelector('.exp-role')?.value || '',
                date: card.querySelector('.exp-date')?.value || '',
                context: card.querySelector('.exp-context')?.value || '',
                bullets: card.querySelector('.exp-bullets')?.value || ''
            })),
            education: Array.from(document.querySelectorAll('#educationList > div')).map(card => ({
                degree: card.querySelector('.edu-degree')?.value || '',
                school: card.querySelector('.edu-school')?.value || '',
                year: card.querySelector('.edu-year')?.value || ''
            })),
            lastSaved: new Date()
        };

        try {
            await setDoc(doc(db, "drafts", user.uid), draftData, { merge: true });
            const badge = document.getElementById('saveStatus');
            badge.classList.replace('opacity-0', 'opacity-100');
            setTimeout(() => badge.classList.replace('opacity-100', 'opacity-0'), 2000);
        } catch (e) {
            console.error("Save Error:", e);
        }
    };

    async function loadFromFirebase(user) {
        const docSnap = await getDoc(doc(db, "drafts", user.uid));
        if (docSnap.exists()) {
            const data = docSnap.data();
            
            document.getElementById('fullName').value = data.fullName || '';
            document.getElementById('jobTitle').value = data.jobTitle || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('email').value = data.email || '';
            document.getElementById('linkedin').value = data.linkedin || '';
            document.getElementById('location').value = data.location || '';
            document.getElementById('summary').value = data.summary || '';
            document.getElementById('careerLevel').value = data.careerLevel || 'Mid-Level';
            document.getElementById('impactScale').value = data.impactScale || 'individual';
            document.getElementById('roleCluster').value = data.roleCluster || 'Operations';
            
            window.skills = data.skills || [];
            window.customCerts = data.customCerts || [];
            
            // Re-render lists
            document.getElementById('experienceList').innerHTML = '';
            if(data.experience) data.experience.forEach(exp => window.addExperience(exp));
            
            document.getElementById('educationList').innerHTML = '';
            if(data.education) data.education.forEach(edu => window.addEducation(edu));

            if(typeof renderSkills === 'function') renderSkills();
            if(typeof renderCustomCerts === 'function') renderCustomCerts();
        } else {
            window.addExperience();
            window.addEducation();
        }
    }

    // --- AUTO-SAVE DEBOUNCE ---
    let saveTimeout;
    document.addEventListener('input', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveToFirebase(), 2000);
        }
    });

    function denyAccess() {
        userHasAccess = false;
        const badge = document.getElementById('accessStatus');
        if(badge) {
            badge.innerHTML = `<span class="text-red-400"><i class="fas fa-lock mr-1"></i> 0 CREDITS</span>`;
        }
    }


